<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <title>Scale pentatoniche – Trainer CAGED di Francesco Morgante</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;600&display=swap" rel="stylesheet">
  <style>
  :root {
    --font-sans: "Inter", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    --font-mono: "JetBrains Mono", ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;

    --radius-lg: 18px;
    --radius-md: 10px;

    --shadow-soft: 0 12px 30px rgba(15, 23, 42, 0.18);
  }

  /* ====== TEMI ====== */

  body.theme-dark {
    --bg-body: #020617;
    --bg-card: #020617;
    --bg-elevated: #020617;
    --bg-fretboard: #020617;
    --bg-fret-cell: #020617;

    --text-body: #e5e7eb;
    --text-muted: #9ca3af;
    --text-soft: #6b7280;
    --text-strong: #f9fafb;

    --border-subtle: #1f2937;
    --border-table: #1f2937;

    --accent: #3b82f6;
    --accent-soft: #1d4ed8;
    --accent-soft-alt: #0f172a;
    --accent-badge: #1e293b;

    --note-root-bg: #facc15;
    --note-root-text: #111827;
    --note-scale-bg: #2563eb;
    --note-scale-text: #e5e7eb;

    --legend-scale: #2563eb;
    --legend-root: #facc15;
  }

  body.theme-light {
    --bg-body: #f4f5fb;
    --bg-card: #ffffff;
    --bg-elevated: #ffffff;
    --bg-fretboard: #f9fafb;
    --bg-fret-cell: #ffffff;

    --text-body: #111827;
    --text-muted: #6b7280;
    --text-soft: #9ca3af;
    --text-strong: #020617;

    --border-subtle: #e5e7eb;
    --border-table: #d1d5db;

    --accent: #2563eb;
    --accent-soft: #dbeafe;
    --accent-soft-alt: #eff6ff;
    --accent-badge: #e5e7eb;

    --note-root-bg: #facc15;
    --note-root-text: #1f2937;
    --note-scale-bg: #2563eb;
    --note-scale-text: #ffffff;

    --legend-scale: #2563eb;
    --legend-root: #facc15;
  }

  /* ====== LAYOUT BASE ====== */

  body {
    margin: 0;
    font-family: var(--font-sans);
    background-color: var(--bg-body);
    color: var(--text-body);
    display: flex;
    justify-content: center;
    align-items: flex-start;
    min-height: 100vh;
    transition: background-color 0.25s ease, color 0.25s ease;
  }

  .app-container {
    max-width: 1100px;
    width: 100%;
    padding: 24px;
    box-sizing: border-box;
  }

  h1 {
    font-size: 2rem;
    font-weight: 600;
    letter-spacing: 0.02em;
    margin-bottom: 4px;
  }

  .subtitle {
    font-size: 0.9rem;
    color: var(--text-muted);
    margin-bottom: 16px;
  }

  .card {
    background: var(--bg-card);
    border-radius: var(--radius-lg);
    padding: 16px 20px;
    box-shadow: var(--shadow-soft);
    margin-bottom: 20px;
    border: 1px solid var(--border-subtle);
  }

  .controls {
    display: flex;
    flex-wrap: wrap;
    gap: 16px;
    align-items: center;
    margin-bottom: 8px;
  }

  .control-group {
    display: flex;
    flex-direction: column;
    gap: 4px;
    font-size: 0.85rem;
  }

  label {
    color: var(--text-muted);
    font-weight: 500;
  }

  select {
    background: var(--bg-elevated);
    color: var(--text-body);
    border: 1px solid var(--border-subtle);
    border-radius: 999px;
    padding: 6px 12px;
    font-size: 0.9rem;
    outline: none;
    min-width: 150px;
    transition: border-color 0.15s ease, box-shadow 0.15s ease, background-color 0.15s ease;
  }

  select:focus {
    border-color: var(--accent);
    box-shadow: 0 0 0 1px rgba(37, 99, 235, 0.5);
  }

  .badge {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding: 4px 10px;
    border-radius: 999px;
    background: var(--accent-badge);
    color: var(--text-strong);
    font-size: 0.75rem;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    white-space: nowrap;
  }

  .info {
    font-size: 0.9rem;
    color: var(--text-muted);
    margin-top: 6px;
  }

  .scale-notes {
    margin-top: 6px;
    font-size: 0.95rem;
  }

  .scale-notes span {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    margin-right: 6px;
    margin-bottom: 4px;
    padding: 4px 10px;
    border-radius: 999px;
    background: var(--accent-soft-alt);
    border: 1px solid var(--border-subtle);
    font-size: 0.85rem;
    font-weight: 500;
  }

  /* ====== FRETBOARD ====== */

  .fretboard-container {
    overflow-x: auto;
    padding-bottom: 10px;
  }

  .fretboard {
    border-collapse: collapse;
    width: 100%;
    min-width: 780px;
    table-layout: fixed;
    font-size: 0.75rem;
    background: var(--bg-fretboard);
  }

  .fretboard th,
  .fretboard td {
    border: 1px solid var(--border-table);
    text-align: center;
    padding: 4px 2px;
  }

  .fretboard th {
    background: var(--bg-elevated);
    position: sticky;
    top: 0;
    z-index: 2;
    font-weight: 500;
    color: var(--text-muted);
  }

  .string-label {
    background: var(--bg-elevated);
    font-weight: 600;
    width: 52px;
    font-family: var(--font-mono);
    font-size: 0.75rem;
  }

  .note-cell {
    position: relative;
    height: 34px;
    cursor: default;
    background: var(--bg-fret-cell);
  }

  .note-name {
    position: relative;
    z-index: 2;
    font-family: var(--font-mono);
    font-size: 0.7rem;
  }

  .in-scale {
    background-color: var(--note-scale-bg);
    color: var(--note-scale-text);
    font-weight: 600;
  }

  .root-note {
    background-color: var(--note-root-bg);
    color: var(--note-root-text);
    font-weight: 700;
  }

  .note-degree {
    display: block;
    font-size: 0.65rem;
    color: var(--bg-fretboard);
  }

  .legend {
    display: flex;
    gap: 12px;
    align-items: center;
    font-size: 0.8rem;
    margin-top: 8px;
    color: var(--text-soft);
    flex-wrap: wrap;
  }

  .legend-item {
    display: flex;
    align-items: center;
    gap: 6px;
  }

  .legend-swatch {
    width: 14px;
    height: 14px;
    border-radius: 4px;
    border: 1px solid var(--border-subtle);
  }

  .legend-swatch.scale {
    background: var(--legend-scale);
  }

  .legend-swatch.root {
    background: var(--legend-root);
  }

  .footnote {
    font-size: 0.75rem;
    color: var(--text-soft);
    margin-top: 8px;
    line-height: 1.4;
  }

  .box-info {
    font-size: 0.8rem;
    color: var(--text-muted);
    margin-top: 6px;
  }

  /* ====== BOTTONE TEMA ====== */

  .theme-toggle {
    position: absolute;
    top: 20px;
    right: 24px;
    padding: 6px 14px;
    border-radius: 999px;
    border: 1px solid var(--border-subtle);
    background: var(--bg-elevated);
    color: var(--text-body);
    font-size: 0.8rem;
    font-weight: 500;
    display: inline-flex;
    align-items: center;
    gap: 6px;
    cursor: pointer;
    transition: background-color 0.15s ease, border-color 0.15s ease, transform 0.1s ease;
  }

  .theme-toggle:hover {
    border-color: var(--accent);
    transform: translateY(-1px);
  }

  .theme-toggle-icon {
    width: 14px;
    height: 14px;
    border-radius: 50%;
    background: var(--accent);
  }

  @media (max-width: 640px) {
    h1 {
      font-size: 1.5rem;
    }
    .app-container {
      padding: 16px;
    }
    select {
      min-width: 130px;
    }
    .theme-toggle {
      top: 16px;
      right: 16px;
    }
  } /* <--- CHIUSURA DEL MEDIA, PRIMA DELLA VARIANTE D */
 /* ==========================================
   PALLINO COLORATO SOPRA + CELLA SOFT
   (nota + grado restano sotto, markup invariato)
   ========================================== */

/* Colori pallino e tinta cella */
:root {
  --note-normal-red: #e11d48;              /* pallino note normali */
  --note-root-yellow: #facc15;             /* pallino tonica */
  --note-cell-scale-soft: rgba(225,17,72,0.12);   /* sfondo tenue per note scala */
  --note-cell-root-soft:  rgba(250,204,21,0.16);  /* sfondo tenue per tonica */
}

/* Cella con nota in scala: sfondo tenue */
.fretboard .note-cell.in-scale {
  background-color: var(--note-cell-scale-soft);
  color: var(--text-body);
}

/* Cella con tonica: sfondo tenue giallino */
.fretboard .note-cell.root-note {
  background-color: var(--note-cell-root-soft);
  color: var(--text-body);
}

/* Base della nota: spazio per il pallino sopra */
.fretboard .note-name {
  font-family: var(--font-mono);
  font-size: 0.7rem;
  color: var(--text-body);
  display: inline-block;
  text-align: center;
  padding-top: 20px; /* spazio per il pallino */
  position: relative;
  line-height: 1.1;
}

/* Pallino sopra le scritte */
.fretboard .note-name::before {
  content: "";
  position: absolute;
  top: 2px;
  left: 50%;
  transform: translateX(-50%);
  width: 14px;
  height: 14px;
  border-radius: 999px;
  box-shadow: 0 0 0 1px var(--bg-fretboard);
  background: transparent; /* sarà colorato dalle regole sotto */
}

/* Colori del pallino */
.fretboard .note-cell.in-scale .note-name::before {
  background: var(--note-normal-red);
}

.fretboard .note-cell.root-note .note-name::before {
  background: var(--note-root-yellow);
}

/* Gradi sotto la nota: chiari e leggibili su sfondo scuro/soft */
.fretboard .note-degree {
  display: block;
  font-size: 0.65rem;
  color: #e5e7eb;
}

/* Legenda coerente con i nuovi colori */
.legend-swatch.scale {
  background: var(--note-normal-red);
}

.legend-swatch.root {
  background: var(--note-root-yellow);
}
    /* === LOGO HEADER === */
.app-logo {
  width: 25%;              /* prende il 25% della larghezza */
  max-width: 260px;        /* non diventa gigante sugli schermi larghi */
  min-width: 140px;        /* resta leggibile su iPhone */
  margin: 0 auto 22px auto;
  display: flex;
  justify-content: center;
}

.app-logo img {
  width: 100%;
  height: auto;
  display: block;
  opacity: 0.95;
  filter: drop-shadow(0 6px 12px rgba(0,0,0,0.25));
  transition: opacity 0.25s ease;
}

.app-logo img:hover {
  opacity: 1;
}
}
</style>
</head>
<body>
  <body class="theme-dark">
  <div class="app-container">
<div class="theme-toggle-wrapper">
  <button id="themeToggle" type="button" class="theme-toggle">
    <span class="theme-toggle-icon"></span>
    <span id="themeToggleLabel">Tema chiaro</span>
  </button>
</div>   
    <div class="app-logo">
  <img src="assets/images/logo-morgan-guitar.png" alt="Morgan Guitar Studio Logo">
</div>
    <h1>Pentatoniche facili con MORGAN GUITAR STUDIO </h1>
    <div class="subtitle">
      Scegli tonalità, tipo di scala, notazione e box. Visualizza le note sul manico in stile CAGED. Ma soprattutto adesso non hai scuse per non studiare
    </div>

    <div class="card">
      <div class="controls">
        <div class="control-group">
          <label for="rootSelect">Nota fondamentale</label>
          <select id="rootSelect"></select>
        </div>

        <div class="control-group">
          <label for="typeSelect">Tipo di scala</label>
          <select id="typeSelect">
            <option value="minor">Pentatonica minore</option>
            <option value="major">Pentatonica maggiore</option>
          </select>
        </div>
        
          <div class="control-group">
          <label for="majorModeSelect">Modo scala maggiore</label>
          <select id="majorModeSelect">
            <option value="relative">Relativa minore (stessi box)</option>
            <option value="trueMajor">Maggiore “reale” (box sulla tonica)</option>
          </select>
        </div>

        <div class="control-group">
          <label for="viewModeSelect">Visualizzazione</label>
          <select id="viewModeSelect">
            <option value="full">Manico intero</option>
            <option value="boxes">Box (metodo CAGED)</option>
          </select>
        </div>
        
        <div class="control-group">
          <label for="boxSelect">Box</label>
          <select id="boxSelect" disabled>
            <option value="1">Box 1 (forma A)</option>
            <option value="2">Box 2 (forma G)</option>
            <option value="3">Box 3 (forma E)</option>
            <option value="4">Box 4 (forma D)</option>
            <option value="5">Box 5 (forma C)</option>
          </select>
        </div>

        <div class="control-group">
          <label for="notationSelect">Notazione</label>
          <select id="notationSelect">
            <option value="en">A B C</option>
            <option value="it">Do Re Mi</option>
            <option value="both">A B C + Do Re Mi</option>
          </select>
        </div>
        
       <div class="control-group">
            <label for="fretCountSelect">Tasti visibili</label>
            <select id="fretCountSelect">
              <option value="12">0–12</option>
              <option value="15">0–15</option>
              <option value="17">0–17</option>
              <option value="21">0–21</option>
              <option value="24">0–24</option>
            </select>
        </div>
        
        <div class="control-group">
          <span class="badge" id="scaleLabel">Scala</span>
        </div>
      </div>

      <div class="info">
        <div id="scaleDescription"></div>
        <div class="scale-notes" id="scaleNotes"></div>
      </div>
    </div>

    <div class="card">
      <div class="fretboard-container">
        <table class="fretboard" id="fretboard"></table>
      </div>
      <div class="box-info" id="boxInfo"></div>
      <div class="legend">
        <div class="legend-item">
          <div class="legend-swatch root"></div>
          <span>Tonica</span>
        </div>
        <div class="legend-item">
          <div class="legend-swatch scale"></div>
          <span>Altre note della scala</span>
        </div>
      </div>
      <div class="footnote">
        Lettura dall'alto verso il basso: 1ª corda (cantino) → 6ª corda (basso).<br>
        In modalità "Box" vengono evidenziate solo le note della scala all'interno del box
        CAGED relativo alla posizione scelta (due note per corda).
      </div>
    </div>
  </div>

<script>
  (function () {
    // =========================
    // DATI DI BASE
    // =========================

    // Notazione anglosassone e italiana
    var EN_NOTES = ["C", "C#", "D", "D#", "E", "F", "F#", "G", "G#", "A", "A#", "B"];
    var IT_NOTES = ["Do", "Do#", "Re", "Re#", "Mi", "Fa", "Fa#", "Sol", "Sol#", "La", "La#", "Si"];

    // Tuning chitarra standard dal basso verso l'alto: E A D G B E
    // Indici rispetto a C=0
    // Indice 0 = 6ª corda (E bassa), 5 = 1ª corda (E cantino)
    var TUNING = [4, 9, 2, 7, 11, 4];

    // Tipi di scala pentatonica
    var SCALE_TYPES = {
      minor: {
        name: "Pentatonica minore",
        intervals: [0, 3, 5, 7, 10],  // 1, ♭3, 4, 5, ♭7
        degrees: ["1", "♭3", "4", "5", "♭7"]
      },
      major: {
        name: "Pentatonica maggiore",
        intervals: [0, 2, 4, 7, 9],   // 1, 2, 3, 5, 6
        degrees: ["1", "2", "3", "5", "6"]
      }
    };

    // BOX PENTATONICI MINORI DI A (La) – come indicati da te
    // Chiave: box "1"–"5"; valore: frets per corda (6→1)
    var BOX_PATTERNS_MINOR = {
      "1": { // A min box 1
        6: [5, 8],
        5: [5, 7],
        4: [5, 7],
        3: [5, 7],
        2: [5, 8],
        1: [5, 8]
      },
      "2": { // A min box 2
        6: [8, 10],
        5: [7, 10],
        4: [7, 10],
        3: [7, 9],
        2: [8, 10],
        1: [8, 10]
      },
      "3": { // A min box 3
        6: [10, 12],
        5: [10, 12],
        4: [10, 12],
        3: [9, 12],
        2: [10, 13],
        1: [10, 12]
      },
      "4": { // A min box 4
        6: [12, 15],
        5: [12, 15],
        4: [12, 14],
        3: [12, 14],
        2: [13, 15],
        1: [12, 15]
      },
      "5": { // A min box 5
        6: [15, 17],
        5: [15, 17],
        4: [14, 17],
        3: [14, 17],
        2: [15, 17],
        1: [15, 17]
      }
    };

    var BASE_MINOR_ROOT_INDEX = 9; // A
    // =========================
    // RIFERIMENTI DOM
    // =========================

    var rootSelect,
      typeSelect,
      majorModeSelect,
      viewModeSelect,
      boxSelect,
      notationSelect,
      fretCountSelect,
      fretboardEl,
      scaleLabelEl,
      scaleDescEl,
      scaleNotesEl,
      boxInfoEl;

    function initDomRefs() {
      rootSelect      = document.getElementById("rootSelect");
      typeSelect      = document.getElementById("typeSelect");
      majorModeSelect = document.getElementById("majorModeSelect");
      viewModeSelect  = document.getElementById("viewModeSelect");
      boxSelect       = document.getElementById("boxSelect");
      notationSelect  = document.getElementById("notationSelect");
      fretCountSelect = document.getElementById("fretCountSelect");
      fretboardEl     = document.getElementById("fretboard");
      scaleLabelEl    = document.getElementById("scaleLabel");
      scaleDescEl     = document.getElementById("scaleDescription");
      scaleNotesEl    = document.getElementById("scaleNotes");
      boxInfoEl       = document.getElementById("boxInfo");
    }

    // =========================
    // FUNZIONI UTILI
    // =========================

    // Popola select della nota fondamentale
    function initRootSelect() {
      if (!rootSelect) return;
      rootSelect.innerHTML = "";
      var i;
      for (i = 0; i < 12; i++) {
        var opt = document.createElement("option");
        opt.value = i;
        opt.textContent = EN_NOTES[i] + " (" + IT_NOTES[i] + ")";
        rootSelect.appendChild(opt);
      }
      // Default: A (La)
      rootSelect.value = "9";
    }

    // Etichetta nota secondo notazione
    function getNoteLabel(noteIndex, notationMode) {
      var en = EN_NOTES[noteIndex];
      var it = IT_NOTES[noteIndex];
      if (notationMode === "en") {
        return en;
      } else if (notationMode === "it") {
        return it;
      } else if (notationMode === "both") {
        return en + " / " + it;
      }
      return en;
    }

    // Scala da tonica e tipo
    function getScale(rootIndex, typeKey) {
      var type = SCALE_TYPES[typeKey];
      var noteIndices = [];
      var i;
      for (i = 0; i < type.intervals.length; i++) {
        noteIndices.push((rootIndex + type.intervals[i]) % 12);
      }
      return { type: type, noteIndices: noteIndices };
    }

    // Grado (1, ♭3, ecc.) per nota specifica
    function getDegreeForNote(noteIndex, rootIndex, typeKey) {
      var type = SCALE_TYPES[typeKey];
      var diff = (noteIndex - rootIndex + 12) % 12;
      var i;
      for (i = 0; i < type.intervals.length; i++) {
        if (type.intervals[i] === diff) {
          return type.degrees[i];
        }
      }
      return null;
    }

    // Fret della radice su 6ª corda (E bassa), 0–24
    function getRootFretOnSixthString(rootIndex) {
      var stringIndex = 0; // 6ª corda
      var fret;
      for (fret = 0; fret <= 24; fret++) {
        var noteIndex = (TUNING[stringIndex] + fret) % 12;
        if (noteIndex === rootIndex) {
          return fret;
        }
      }
      return 0;
    }

    // Trasposizione di un box minore (definito per A) su un'altra radice (spatialRootIndex)
    function getTransposedBoxFrets(spatialRootIndex, boxNumber) {
      var boxKey = String(boxNumber);
      var baseBox = BOX_PATTERNS_MINOR[boxKey];
      if (!baseBox) return null;

      var baseRootFret6 = getRootFretOnSixthString(BASE_MINOR_ROOT_INDEX); // A su 6ª
      var targetRootFret6 = getRootFretOnSixthString(spatialRootIndex);
      var delta = targetRootFret6 - baseRootFret6;

      var perString = {};
      var minFret = null;
      var maxFret = null;

      var stringNum;
      for (stringNum in baseBox) {
        if (!baseBox.hasOwnProperty(stringNum)) continue;
        var frets = baseBox[stringNum];
        var newFrets = [];
        var i;
        for (i = 0; i < frets.length; i++) {
          var nf = frets[i] + delta;
          newFrets.push(nf);
          if (minFret === null || nf < minFret) minFret = nf;
          if (maxFret === null || nf > maxFret) maxFret = nf;
        }
        perString[stringNum] = newFrets;
      }

      return { perString: perString, minFret: minFret, maxFret: maxFret };
    }

    // =========================
    // RENDER MANICO
    // =========================

    // displayRootIndex = tonica teorica (es. C maggiore)
    // spatialRootIndex = radice usata per ancorare i box (es. relativa minore A)
    function renderFretboard(displayRootIndex, spatialRootIndex, typeKey, viewMode, boxNumber, notationMode, maxFrets) {
      if (!fretboardEl) return;

      var scaleObj = getScale(displayRootIndex, typeKey);
      var noteIndices = scaleObj.noteIndices;

      var numFrets = maxFrets || 12;
      var useBoxes = (viewMode === "boxes");
      var boxData = null;
      if (useBoxes) {
        boxData = getTransposedBoxFrets(spatialRootIndex, boxNumber);
      }

      // Pulisci tabella
      fretboardEl.innerHTML = "";

      // Header tasti
      var headerRow = document.createElement("tr");
      var cornerTh = document.createElement("th");
      cornerTh.textContent = "";
      headerRow.appendChild(cornerTh);

      var fret;
      for (fret = 0; fret <= numFrets; fret++) {
        var th = document.createElement("th");
        th.textContent = fret;
        headerRow.appendChild(th);
      }
      fretboardEl.appendChild(headerRow);

      // Corde: dalla 1ª alla 6ª (indice interno 5→0)
      var s;
      for (s = 5; s >= 0; s--) {
        var row = document.createElement("tr");

        var stringLabelCell = document.createElement("td");
        stringLabelCell.className = "string-label";
        stringLabelCell.textContent = getNoteLabel(TUNING[s], notationMode);
        row.appendChild(stringLabelCell);

        for (fret = 0; fret <= numFrets; fret++) {
          var cell = document.createElement("td");
          cell.className = "note-cell";

          var noteIndex = (TUNING[s] + fret) % 12;
          var degree = getDegreeForNote(noteIndex, displayRootIndex, typeKey);
          var label = getNoteLabel(noteIndex, notationMode);

          var span = document.createElement("span");
          span.className = "note-name";
          span.textContent = label;

          var inScale = noteIndices.indexOf(noteIndex) !== -1;
          var isRoot = (noteIndex === displayRootIndex);

          if (!useBoxes) {
            // MANICO INTERO
            if (isRoot) {
              cell.classList.add("root-note");
            } else if (inScale) {
              cell.classList.add("in-scale");
            }
          } else if (boxData && boxData.perString) {
            // BOX CAGED – usa solo i frets definiti nel pattern trasposto
            var stringNum = 6 - s; // 6ª corda (s=0) → 6; 1ª corda (s=5) → 1
            var allowedArray = boxData.perString[stringNum];
            var isInBox = false;
            if (allowedArray) {
              var i;
              for (i = 0; i < allowedArray.length; i++) {
                if (allowedArray[i] === fret) {
                  isInBox = true;
                  break;
                }
              }
            }

            if (isInBox && inScale) {
              if (isRoot) {
                cell.classList.add("root-note");
              } else {
                cell.classList.add("in-scale");
              }
            }
          }

          if (degree) {
            var br = document.createElement("br");
            var degSpan = document.createElement("span");
            degSpan.className = "note-degree";
            degSpan.textContent = degree;
            span.appendChild(br);
            span.appendChild(degSpan);
          }

          cell.appendChild(span);
          row.appendChild(cell);
        }

        fretboardEl.appendChild(row);
      }
    }

    // =========================
    // INFO TESTUALI
    // =========================

    function updateInfo(displayRootIndex, spatialRootIndex, typeKey, notationMode, viewMode, boxNumber, maxFrets) {
      if (!scaleLabelEl || !scaleDescEl || !scaleNotesEl || !boxInfoEl) return;

      var scaleObj = getScale(displayRootIndex, typeKey);
      var type = scaleObj.type;
      var noteIndices = scaleObj.noteIndices;

      var rootLabelEn = EN_NOTES[displayRootIndex];
      var rootLabelIt = IT_NOTES[displayRootIndex];
      var rootDisplay;

      if (notationMode === "en") {
        rootDisplay = rootLabelEn;
      } else if (notationMode === "it") {
        rootDisplay = rootLabelIt;
      } else if (notationMode === "both") {
        rootDisplay = rootLabelEn + " / " + rootLabelIt;
      } else {
        rootDisplay = rootLabelEn;
      }

      scaleLabelEl.textContent = type.name + " di " + rootDisplay;

      // Descrizione intervalli
      scaleDescEl.textContent =
        type.name + " su " + rootDisplay + ": gradi " + type.degrees.join(" – ") +
        " (in semitoni dalla tonica: " + type.intervals.join(", ") + ").";

      // Note della scala
      scaleNotesEl.innerHTML = "";
      var i;
      for (i = 0; i < noteIndices.length; i++) {
        var noteIndex = noteIndices[i];
        var chip = document.createElement("span");
        var noteLabel = getNoteLabel(noteIndex, notationMode);
        if (i === 0) {
          chip.textContent = noteLabel + " (1)";
        } else {
          chip.textContent = noteLabel;
        }
        scaleNotesEl.appendChild(chip);
      }

      // Info box / manico intero
      var majorMode = majorModeSelect ? majorModeSelect.value : "relative";
      var fretInfo = maxFrets || 12;

      if (viewMode === "boxes") {
        var boxData = getTransposedBoxFrets(spatialRootIndex, boxNumber);
        if (boxData) {
          var minF = boxData.minFret;
          var maxF = boxData.maxFret;
          // clamp ai tasti visibili
          if (minF < 0) minF = 0;
          if (maxF > fretInfo) maxF = fretInfo;

          var spatialRootLabel = getNoteLabel(spatialRootIndex, notationMode);
          var extra;
          if (typeKey === "major" && majorMode === "relative") {
            extra = " (box costruito sulla relativa minore " + spatialRootLabel +
              " sulla 6ª corda, ma con tonica teorica " + rootDisplay + ").";
          } else {
            extra = " (box costruito sulla tonica " + spatialRootLabel +
              " sulla 6ª corda).";
          }

          boxInfoEl.textContent =
            "Box " + boxNumber +
            ": note della scala tra i tasti " + minF + " e " + maxF +
            " (visualizzazione fino al tasto " + fretInfo + ")" +
            extra;
        } else {
          boxInfoEl.textContent = "Box non disponibile per questa combinazione.";
        }
      } else {
        boxInfoEl.textContent =
          "Manico intero: tutte le note della scala sono evidenziate sui primi " +
          fretInfo + " tasti (0–" + fretInfo + ").";
      }
    }

    // =========================
    // GESTIONE SELECT / UPDATE
    // =========================

    function updateBoxSelectState() {
      if (!viewModeSelect || !boxSelect) return;
      var viewMode = viewModeSelect.value;
      boxSelect.disabled = (viewMode !== "boxes");
    }

    function updateMajorModeSelectState() {
      if (!typeSelect || !majorModeSelect) return;
      var typeKey = typeSelect.value;
      majorModeSelect.disabled = (typeKey !== "major");
    }

    function updateAll() {
      if (!rootSelect || !typeSelect || !viewModeSelect || !notationSelect || !boxSelect) return;

      var displayRootIndex = parseInt(rootSelect.value, 10);
      var typeKey = typeSelect.value;
      var viewMode = viewModeSelect.value;
      var boxNumber = parseInt(boxSelect.value, 10);
      var notationMode = notationSelect.value;
      var majorMode = majorModeSelect ? majorModeSelect.value : "relative";
      var maxFrets = 12;

      if (fretCountSelect) {
        var parsed = parseInt(fretCountSelect.value, 10);
        if (!isNaN(parsed) && parsed > 0) {
          maxFrets = parsed;
        }
      }

      // Radice "spaziale" per ancorare i box
      var spatialRootIndex = displayRootIndex;

      if (typeKey === "major") {
        if (majorMode === "relative") {
          // relativa minore: 3 semitoni sotto
          spatialRootIndex = (displayRootIndex + 9) % 12;
        } else {
          // maggiore reale: stesso root
          spatialRootIndex = displayRootIndex;
        }
      }

      updateBoxSelectState();
      updateMajorModeSelectState();
      updateInfo(displayRootIndex, spatialRootIndex, typeKey, notationMode, viewMode, boxNumber, maxFrets);
      renderFretboard(displayRootIndex, spatialRootIndex, typeKey, viewMode, boxNumber, notationMode, maxFrets);
    }

    function safeInit() {
      initDomRefs();
      if (!rootSelect) return;
      initRootSelect();
      updateAll();

      // Event listeners
      rootSelect.addEventListener("change", updateAll);
      typeSelect.addEventListener("change", updateAll);
      if (majorModeSelect) {
        majorModeSelect.addEventListener("change", updateAll);
      }
      viewModeSelect.addEventListener("change", updateAll);
      boxSelect.addEventListener("change", updateAll);
      notationSelect.addEventListener("change", updateAll);
      if (fretCountSelect) {
        fretCountSelect.addEventListener("change", updateAll);
      }
    }

    if (document.readyState === "loading") {
      document.addEventListener("DOMContentLoaded", safeInit);
    } else {
      safeInit();
    }
  })();
</script>

    <script>
  (function () {
    function applyTheme(theme) {
      var body = document.body;
      var btnLabel = document.getElementById("themeToggleLabel");
      if (!body || !btnLabel) return;

      body.classList.remove("theme-dark", "theme-light");
      if (theme === "light") {
        body.classList.add("theme-light");
        btnLabel.textContent = "Tema scuro";
      } else {
        body.classList.add("theme-dark");
        btnLabel.textContent = "Tema chiaro";
      }
    }

    function initThemeToggle() {
      var stored = null;
      try {
        stored = localStorage.getItem("guitarstudio-theme");
      } catch (e) {}

      var initial = (stored === "light" || stored === "dark") ? stored : "dark";
      applyTheme(initial);

      var btn = document.getElementById("themeToggle");
      if (!btn) return;

      btn.addEventListener("click", function () {
        var current = document.body.classList.contains("theme-light") ? "light" : "dark";
        var next = current === "light" ? "dark" : "light";
        applyTheme(next);
        try {
          localStorage.setItem("guitarstudio-theme", next);
        } catch (e) {}
      });
    }

    if (document.readyState === "loading") {
      document.addEventListener("DOMContentLoaded", initThemeToggle);
    } else {
      initThemeToggle();
    }
  })();
</script>
</body>
</html>



















